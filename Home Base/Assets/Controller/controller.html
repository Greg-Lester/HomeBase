<head>
  <meta charset="UTF-8">
  <style>
    html, body, .arrow-wrapper {
      width:100%;
      height:100%;
      padding: 0;
      margin:0;
      background:  radial-gradient(#333, black);
      overflow:hidden;
    }
    .arrow-wrapper{
    }
    .arrow{
      display:inline-block;
      color: orange;
      font-size: 400px;
      transform: scale(0.2);
      transform-origin: right;
    }
    .header{
      position: fixed;
      background: darkgrey;
      top:0;
      width:100%;
      left: 0;
      right: 0;
      padding: 5px;
      font-size: 35px;
      text-align: center;
      font-family: monospace;
      color: white;
    }
  </style>

  <script type="text/javascript" src="https://hammerjs.github.io/dist/hammer.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.7.0.js"></script>
</head>
<body>
  <div class="header">
    Not Connected
  </div>
  <div class="arrow-wrapper">
    <div class="arrow">
      ‚üπ
    </div>
  </div>

  <script>
    let GLOBAL = {
      visibility: 'hidden',
      touch_x: 0,
      touch_y: 0,
      scale: 1,
      rotate: 0
    }

    let player_colors = {
        0: "red",
        1: "blue"
    }

    function update_transforms(){
      let translate = 'translate('+GLOBAL.touch_x+'px, '+GLOBAL.touch_y+'px)'
      let scale = 'scale('+GLOBAL.scale+')'
      let rotate = 'rotate('+GLOBAL.rotate+'rad)'
      let transform = [translate, scale, rotate].join(' ');
      $('.arrow').css('transform', transform);
      $('.arrow').css('visibility', GLOBAL.visibility);
    }
    update_transforms();
    var air_console = new AirConsole();

    let interval = setInterval(()=>{
      let device_id = air_console.device_id;
      let player_id = air_console.convertDeviceIdToPlayerNumber(device_id)
      console.log(">>>>>", device_id, player_id)
      if(player_id !== undefined){
        let color = player_colors[player_id];
        $('.header')
          .text(color.toUpperCase() + " PLAYER")
          .css("background", color)
        $('.arrow')
          .css("color", color)
        GLOBAL.player_id = player_id;
        clearInterval(interval)
      }
    },250);

    window.onerror = function myErrorHandler(errorMsg) {
      console.error(errorMsg);//or any message
      air_console.message(AirConsole.SCREEN, {
        err: errorMsg
      });
      return false;
  }

    var myOptions = {};
    var elem = $('.arrow-wrapper')[0];
    console.log(elem);
    var hammertime = new Hammer(elem, myOptions);

    $('html, body, .arrow-wrapper').each((i, e) => {
      e.addEventListener('touchmove', function(eve) {
          eve.preventDefault();
      }, false);
    });

    hammertime.on('panstart', function({center}) {
      let {x, y} = center;
      //mods
      x -= 465;
      y -= 246;
      GLOBAL.touch_x = x;
      GLOBAL.touch_y = y;
      GLOBAL.visibility = "visible";
      update_transforms();
    });

    hammertime.on('pan-down pan-up pan', function({center}) {
      let {x, y} = center;
      //mods
      x -= 465;
      y -= 246;
      let dx = GLOBAL.touch_x - x;
      let dy = GLOBAL.touch_y - y;
      GLOBAL.dx=dx;
      GLOBAL.dy=dy;
      let mag_d = Math.sqrt(dx*dx+dy*dy);
      GLOBAL.scale = mag_d / 400;

      let theta = Math.atan2(dx, dy);
      console.log(theta)
      GLOBAL.rotate = 0.5*Math.PI - theta;
      update_transforms();
    });

    hammertime.on('panend', function() {
      GLOBAL.visibility = "hidden";
      Navigator.vibrate && Navigator.vibrate(300)
      air_console.message(AirConsole.SCREEN, {
        action:"shoot",
        ...GLOBAL
      });
      update_transforms();
    });

  </script>
</body>
